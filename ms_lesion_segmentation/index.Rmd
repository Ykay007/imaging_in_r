---
title: "Image Segmentation"
author: "Kristin Linn"
output:
  ioslides_presentation:
    widescreen: yes
    css: ../styles.css
  beamer_presentation: default
bibliography: ../refs.bib       
---

```{r setup, include=FALSE}
library(methods)
knitr::opts_chunk$set(echo = TRUE, comment = "")
```

## Loading Data
- Let's read in the training images, brain masks, and manual lesion segmentations.

```{r loading}
library(ms.lesion)
library(neurobase)
library(fslr)
library(scales)
library(extrantsr)
files = get_image_filenames_list_by_subject(
  group = "training", 
  type = "coregistered")
t1s = lapply(files, function(x) readnii(x["MPRAGE"]))
t2s = lapply(files, function(x) readnii(x["T2"]))
flairs = lapply(files, function(x) readnii(x["FLAIR"]))
pds = lapply(files, function(x) readnii(x["PD"]))
masks = lapply(files, function(x) readnii(x["Brain_Mask"]))
golds = lapply(files, function(x) readnii(x["mask2"]))
```

## MS Lesion Segmentation with OASIS
- Here's the T1 volume for training subject 05 with the ‘gold standard’ manual lesion segmentation overlayed.

```{r over_show_run}
les_mask = golds$training05
ortho2(t1s$training05, les_mask, col.y = "orange")
```

## MS Lesion Segmentation with OASIS
- OASIS is Automated Statistical Inference for Segmentation [@sweeney2013oasis]
- The OASIS algorithm takes FLAIR, T1, T2, and PD images from patients with multiple sclerosis (MS) and produces OASIS probability maps of MS lesion presence, which can be thresholded into a binary lesion segmentation.
- The OASIS library in R provides default parameters from a previously trained data set.
- To retrain the model using new data, binary masks of `gold standard’ lesion segmentations are needed and should be in T1 space.

## Default OASIS Model
- OASIS uses logistic regression of the labels on the imagess, smoothed versions of the images, and some interaction terms
- The OASIS library comes with default parameters that can be used to generate probability maps for new test subjects

## Default OASIS Model
- Let's read in the test data. 

```{r test_loading}
library(oasis)
test_files = get_image_filenames_list_by_subject(
  group = "testing", 
  type = "coregistered")
test_t1s = lapply(test_files, 
	function(x) readnii(x["MPRAGE"]))
test_t2s = lapply(test_files, 
	function(x) readnii(x["T2"]))
test_flairs = lapply(test_files, 
	function(x) readnii(x["FLAIR"]))
test_pds = lapply(test_files, 
	function(x) readnii(x["PD"]))
test_masks = lapply(test_files, 
	function(x) readnii(x["Brain_Mask"]))
```

## Default OASIS Model
- Here we apply the default OASIS model to the test data to obtain probability maps.

```{r default_predict_show, eval=FALSE}
default_predict = function(x){
  res = oasis_predict(
      flair=test_flairs[[x]], t1=test_t1s[[x]], 
      t2=test_t2s[[x]], pd=test_pds[[x]], 
      brain_mask=test_masks[[x]], 
      preproc=FALSE, normalize=TRUE, 
      model=oasis::oasis_model)
  return(res)
}
default_probs = lapply(1:3, default_predict)
```

```{r default_predict_run, eval=TRUE, echo=FALSE}
default_nii = lapply(test_files, 
	function(x) readnii(x["Default_OASIS"]))
trained_nii = lapply(test_files, 
	function(x) readnii(x["Trained_OASIS"]))
```

## Training OASIS
- We might improve the test subject segmentations by re-training the OASIS model using our five training subjects.


## Making OASIS data frames

- OASIS requires a particular data frame format
- OASIS has an option to preprocess your data for you (preproc)
- OASIS has an option to normalize the intensities of your data for you using a whole-brain normalization (normalize)
- `make_df()` below is a helper function

```{r oasis_df_show, eval=FALSE}
library(oasis)
make_df = function(x){
  res = oasis_train_dataframe(
      flair=flairs[[x]], t1=t1s[[x]], 
      t2=t2s[[x]], pd=pds[[x]], 
      gold_standard=golds[[x]], 
      brain_mask=masks[[x]], 
      preproc=FALSE, normalize=TRUE, 
      return_preproc=FALSE)
  return(res$oasis_dataframe)
}
oasis_dfs = lapply(1:5, make_df)
```

```{r oasis_df_run, eval = TRUE, echo = FALSE}
if(file.exists()){
	
}
oasis_model = 
```

## Training OASIS

```{r oasis_run_show, eval=FALSE}
oasis_model = do.call("oasis_training", args = oasis_dfs)
```


## References {.smaller}
