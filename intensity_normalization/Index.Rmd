---
title: "Intensity Normalization"
author: "Jean-Philippe Fortin"
date: "January 20, 2017"
output: ioslides_presentation
---

## Intensity normalization
- Conventional MRI intensites (T1-w, T2-w, PD, FLAIR) are acquired in arbitrary units, making the images not comparable across scanners and visits. 
- Intensity normalization brings the intensities to a common scale.




## Goals of this tutorial
- Visualize the intensities using boxplots and densities
- Apply the WhiteStripe intensity normalization 
- Apply the RAVEL intensity normalization





## Loading the necessary R packages
We first load the packages containing KIRBY21 data for T1-w, T2-w and FLAIR images:
```{r, warning=FALSE, message=FALSE}
library(kirby21.t1)
library(kirby21.t2)
library(kirby21.flair)
library(oro.nifti)
library(neurobase)
```
We then obtain the paths of the NIfTI files
```{r, warning=FALSE, message=FALSE}
t1.files <- get_t1_filenames()
t2.files <- get_t2_filenames()
flair.files <- get_flair_filenames()
```





## Description of the dataset
For the moment, we will work with the T1-w images. The dataset contains 3 subjects with 2 visits each
```{r, warning=FALSE, message=FALSE}
t1.files 
```





## Reading the images into R:
We read the images into a list in R using the readNIfTI function:
```{r, warning=FALSE, message=FALSE}
images <- lapply(t1.files, readNIfTI)
images[[1]]
```






## Skull-stripping
We read the images into a list in R using the readNIfTI function:
```{r, warning=FALSE, message=FALSE}
library(fslr)
images_ss <- lapply(images, fslbet)
```
and obtaining segmentations:
```{r, warning=FALSE, message=FALSE}
library(extrantsr)
segs  <- lapply(images_ss, otropos)
segs  <- lapply(segs, function(x){x[[1]]})
```



## Visualization of the densities in the white matter (WM)
```{r, warning=FALSE, message=FALSE}
boxplots <- lapply(1:6, function(i){
  x <- images_ss[[i]]
  x <- x[segs[[i]]==3]
  boxplot(x, outline=FALSE, plot=FALSE)$stats
})
boxplots <- do.call(cbind, boxplots)
```

## Visualization of the densities in the white matter (WM)
```{r, warning=FALSE, message=FALSE}
boxplot(boxplots)
```


## Performing WhiteStripe:
We read the images into a list in R using the readNIfTI function:
```{r, warning=FALSE, message=FALSE}
library(WhiteStripe)
images_ws <- lapply(images_ss, function(x){
  indices <- whitestripe(x, type="T1", stripped=TRUE, slices=1:dim(x)[3])$whitestripe.ind
  whitestripe_norm(x, indices)
})
```

## Intensities in the WM after WhiteStripe:
```{r, warning=FALSE, message=FALSE}
boxplots_ws <- lapply(1:6, function(i){
  x <- images_ws[[i]]
  x <- x[segs[[i]]==3]
  boxplot(x, outline=FALSE, plot=FALSE)$stats
})
boxplots_ws <- do.call(cbind, boxplots_ws)
```

## Intensities in the WM after WhiteStripe:
```{r, warning=FALSE, message=FALSE}
boxplot(boxplots_ws)
```

## Intensities in the GM after WhiteStripe:
```{r, warning=FALSE, message=FALSE}
boxplots_ws <- lapply(1:6, function(i){
  x <- images_ws[[i]]
  x <- x[segs[[i]]==3]
  boxplot(x, outline=FALSE, plot=FALSE)$stats
})
boxplots_ws <- do.call(cbind, boxplots_ws)
```

## Intensities in the GM after WhiteStripe:
```{r, warning=FALSE, message=FALSE}
boxplot(boxplots_ws)
abline(h=median(boxplots_ws[3,]))
```


## Intensity normalization with RAVEL

- WhiteStripe is great, it normalized the WM intensities across samples
- Grey matter (GM) and cerebrospinal fluid (CSF) intensites are still not comparable
- RAVEL extends WhiteStripe to make intensites comparable across subjects for all tissues

## RAVEL methodology

## Creating a control region mask

## Performing RAVEL normalization









