---
title: "Image Segmentation"
author: "Kristin Linn"
output:
  ioslides_presentation:
    widescreen: yes
  beamer_presentation: default
bibliography: ../refs.bib      
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  message = FALSE, echo = TRUE, 
  comment = "", 
  warning = FALSE)
```

## Image segmentation 
- We are often interested in subdividing or segmenting the brain into meaningful biological regions of interest (ROIs) for an analysis.
- Examples: tissue segmentation, segmentation of gray matter structures, segmentation of pathology (MS lesions, tumors, ...)

## Goals of this tutorial
- Perform tissue segmentation in R using FSL and ANTs
- Discuss multi-atlas label fusion techniques for segmentation
- Perform automatic MS lesion segmentation using OASIS.

## Loading Data

```{r loading}
library(ms.lesion)
library(neurobase)
library(fslr)
library(oasis)
library(scales)
files = get_image_filenames_list_by_subject(
  type = "coregistered")$training01
t1file = files["MPRAGE"]
maskfile = files["Brain_Mask"]
mask = readnii(maskfile)
t1 = readnii(t1file)
```

```{r window, echo = FALSE}
# t1 = robust_window(t1, probs = c(0, 0.9999))
t1 = window_img(t1, window = c(0, 300))
```


## Tissue Segmentation using FSL FAST

The fslr function fast calls fast from FSL [@fast].  The `--nobias` option tells FSL to not perform inhomogeneity correction. 

```{r fast_show, eval = FALSE}
t1file = files["MPRAGE"]
t1fast = fast(t1, outfile = paste0(nii.stub(t1file), "_FAST"), opts = "--nobias")
```

```{r fast_run, echo = FALSE}
t1fast = readnii(files["FAST"])
```

```{r multi_overlay, eval = FALSE}
separate = lapply(1:3, function(x){
  t1fast == x
})
L = c(MPRAGE = list(t1), separate)
L$MPRAGE = robust_window(L$MPRAGE)
r = range(L$MPRAGE)
L$MPRAGE = (L$MPRAGE - r[1])/(r[2] - r[1])
multi_overlay(L, z = 60)
```
## Results

FAST assumes three tissue classes and produces an image with the three labels, ordered by increasing within-class mean intensities. In a T1 image, this results in 1: CSF, 2: Gray Matter, 3: White Matter.  

## White Matter

```{r fast_wm}
ortho2(t1, t1fast == 3, col.y = alpha("red", 0.5), text = "White Matter")
```

## Gray Matter

```{r fast_gm}
ortho2(t1, t1fast == 2, col.y = alpha("red", 0.5), text="Gray Matter")
```

## CSF

```{r fast_csf}
ortho2(t1, t1fast == 1, col.y = alpha("red", 0.5), text="CSF")
```


## Tissue Segmentation using ANTsR, extrantsr

- Uses Atropos (CITE)

```{r otropos_show, eval = FALSE}
t1_otropos = otropos(a = t1, x = mask)
t1seg = t1_otropos$segmentation
```

```{r otropos_run, echo = FALSE}
t1seg = readnii(files["Tissue_Classes"])
```

## White Matter

```{r otropos_wm}
ortho2(t1, t1seg == 3, col.y = alpha("red", 0.5), text = "White Matter")
```

## Gray Matter

```{r otropos_gm}
ortho2(t1, t1seg == 2, col.y = alpha("red", 0.5), text="Gray Matter")
```

## CSF

```{r otropos_csf}
ortho2(t1, t1seg == 1, col.y = alpha("red", 0.5), text="CSF")
```

### Estimating the Volume of Each Class

We can create a table which will count the number of voxels in each category:

```{r tabs}
tab_fsl = table(t1seg[ t1seg != 0])
tab_fsl
tab_ants = table(t1fast[ t1fast != 0])
tab_ants
names(tab_fsl) = names(tab_ants) = c("CSF", "GM", "WM")
```

### Estimating the Volume of Each Class

By multiplying by the voxel resolution (in cubic centimeters), we can get volumes

```{r volumes}
vres = voxres(t1seg, units = "cm")
vol_fsl = tab_fsl * vres
vol_fsl
vol_ants = tab_ants * vres
vol_ants
```


